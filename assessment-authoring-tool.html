<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Admin | Fluid Editor</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --border: #e5e7eb;
            --bg-subtle: #f9fafb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --json-bg: #1e1e1e;
            --json-fg: #d4d4d4;
            --nav-bg: #1e293b;
            --nav-text: #94a3b8;
            --nav-active: #fff;
            --nav-active-bg: #334155;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: row; height: 100vh; color: var(--text-main); background: white; }

        /* MAIN NAVIGATION (Leftmost Strip) */
        .main-nav {
            width: 64px;
            background: var(--nav-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 1rem;
            flex-shrink: 0;
            z-index: 20;
        }
        .nav-item {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--nav-text);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.5rem;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: var(--nav-active); background: var(--nav-active-bg); box-shadow: 0 0 0 1px rgba(255,255,255,0.1); }
        .nav-label { font-size: 0.6rem; text-align: center; margin-top: -8px; margin-bottom: 1rem; color: var(--nav-text); }

        /* APP CONTENT AREA */
        .app-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .header {
            border-bottom: 1px solid var(--border);
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            height: 60px;
            flex-shrink: 0;
            z-index: 10;
        }
        .header-brand { display: flex; align-items: center; gap: 1rem; }
        .header-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .header-meta { font-size: 0.9rem; color: var(--text-muted); padding-left: 1rem; border-left: 1px solid var(--border); }
        .badge-mode { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-import { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .badge-library { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        
        .actions { display: flex; gap: 0.75rem; }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { background: var(--bg-subtle); border-color: #d1d5db; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-icon { padding: 0.4rem; }

        /* WORKSPACE LAYOUT */
        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR (List View) */
        .sidebar {
            width: 350px;
            border-right: 1px solid var(--border);
            background: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        /* Sidebar Modules (Switchable) */
        .sidebar-module { display: none; flex-direction: column; height: 100%; }
        .sidebar-module.active { display: flex; }

        .sidebar-filter {
            padding: 1rem;
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .sidebar-search {
            padding: 1rem;
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .search-row { display: flex; gap: 0.5rem; }
        .search-select {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }
        .fetch-btn {
            width: 100%;
            background: var(--text-main);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }
        .fetch-btn:hover { background: black; }

        .sidebar-header-status {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .q-list { overflow-y: auto; flex: 1; }
        
        .q-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.1s;
            position: relative;
        }
        .q-item:hover { background: #f8fafc; }
        .q-item.active { background: #eff6ff; border-left: 4px solid var(--primary); padding-left: calc(1.25rem - 4px); }
        
        .q-item-header { display: flex; justify-content: space-between; margin-bottom: 0.25rem; align-items: center; }
        .q-id { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        
        .q-location { font-size: 0.7rem; color: var(--primary); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.02em; }

        .q-preview { font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); font-weight: 500; }
        
        .status-indicator { font-size: 0.7rem; font-weight: 600; display: flex; align-items: center; gap: 5px; margin-top: 6px;}
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .valid { color: var(--success); } .valid .dot { background: var(--success); }
        .pending { color: var(--warning); } .pending .dot { background: var(--warning); }

        /* EDITOR (Detail View) */
        .editor { flex: 1; background: #f3f4f6; overflow-y: auto; padding: 2rem; display: none; }
        .editor.active { display: block; }
        
        .editor-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            min-height: 600px;
        }
        
        .card-header {
            padding: 0;
            border-bottom: 1px solid var(--border);
            background: #fff;
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .header-top { padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        
        .meta-group { display: flex; gap: 1rem; align-items: center; }
        .meta-item { display: flex; flex-direction: column; }
        
        .card-tabs { display: flex; border-top: 1px solid var(--border); background: var(--bg-subtle); }
        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-btn:hover { background: #f3f4f6; }
        .tab-btn.active { background: white; color: var(--primary); border-bottom-color: var(--primary); }

        .card-body { padding: 0; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* EDIT VIEW CONTAINER */
        .edit-view-container { display: none; height: 100%; flex-direction: column; }
        .edit-view-container.active { display: flex; }
        
        /* TOOLBAR */
        .editor-toolbar {
            background: var(--bg-subtle);
            padding: 0.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .toolbar-left, .toolbar-right { display: flex; gap: 1rem; align-items: center; }
        .toolbar-group { display: flex; align-items: center; gap: 0.5rem; padding-right: 1rem; border-right: 1px solid var(--border); }
        .toolbar-group:last-child { border-right: none; }
        .toolbar-label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-right: 0.5rem; }

        /* Sub-View Toggle */
        .view-toggle { display: flex; background: #e5e7eb; border-radius: 6px; padding: 2px; }
        .view-toggle-btn {
            padding: 4px 12px; font-size: 0.75rem; font-weight: 600; border-radius: 4px; cursor: pointer; border: none; background: transparent; color: var(--text-muted);
        }
        .view-toggle-btn.active { background: white; color: var(--text-main); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* GRAPHICAL SUB-VIEW */
        .graphical-view { padding: 2rem; overflow-y: auto; flex: 1; display: block; }

        /* JSON SUB-VIEW */
        .json-view { display: none; flex: 1; flex-direction: column; background: var(--json-bg); position: relative; height: 100%; }
        .json-view.active { display: flex; }
        .json-editor {
            flex: 1; width: 100%; height: 100%; border: none; padding: 1.5rem;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.9rem;
            background: var(--json-bg); color: var(--json-fg); resize: none; outline: none; line-height: 1.5;
            box-sizing: border-box;
        }
        .json-footer {
            padding: 0.5rem 1.5rem; background: #2d2d2d; border-top: 1px solid #333; color: #888; font-size: 0.75rem;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; font-family: sans-serif;
        }

        /* PREVIEW VIEW */
        .preview-view-container { 
            padding: 2rem; background: #525659; display: none; flex: 1; justify-content: center; overflow-y: auto; 
        }
        .preview-view-container.active { display: flex; }
        
        .a4-page {
            width: 210mm; min-height: 297mm; background: white; padding: 12mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.3); font-family: "Times New Roman", serif; font-size: 11pt; line-height: 1.4; color: #000;
        }

        /* CONTENT STYLES */
        .p-q-block { margin-bottom: 1.5rem; text-align: justify; }
        .p-q-header { display: grid; grid-template-columns: 1fr auto; align-items: end; gap: 1rem; margin-bottom: 0.5rem; }
        .p-q-num { font-weight: bold; margin-right: 0.5rem; }
        .p-q-marks { font-size: 10pt; font-weight: bold; white-space: nowrap; }
        
        .p-stimulus { background: #f9fafb; padding: 0.75rem; border: 1px solid #e5e7eb; margin-bottom: 1rem; font-style: italic; text-align: justify; }
        .p-sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .p-sub-item { margin-bottom: 0.75rem; text-align: justify; padding-left: 1.5rem; display: flex; align-items: baseline; }
        .p-sub-label { font-weight: bold; margin-right: 0.5rem; flex-shrink: 0; }
        
        .p-asset { margin: 0.5rem 0; text-align: center; }
        .p-asset img { max-width: 100%; max-height: 200px; border: 1px solid #ccc; }
        .p-asset-placeholder { border: 1px dashed #ccc; padding: 2rem; color: #999; font-family: sans-serif; font-size: 0.8rem; }

        /* FORM CONTROLS */
        .content-section { margin-bottom: 2rem; }
        .input-bare { width: 100%; border: 1px solid transparent; padding: 0.5rem; border-radius: 4px; font-family: inherit; font-size: inherit; color: inherit; background: transparent; resize: none; transition: all 0.2s; }
        .input-bare:hover { background: #f9fafb; border-color: #e5e7eb; }
        .input-bare:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        .prompt-input { font-size: 1.1rem; font-weight: 500; min-height: 3rem; }
        .sub-input { font-size: 0.95rem; min-height: 2.5rem; }
        
        .sub-questions-wrapper { display: flex; flex-direction: column; gap: 1rem; }
        .sub-questions-wrapper.layout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        .sub-question-card { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 1rem; position: relative; transition: box-shadow 0.2s; }
        .sub-question-card:focus-within { border-color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .sub-q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .sub-id-badge { background: #eff6ff; color: var(--primary); font-weight: 700; font-size: 0.8rem; padding: 2px 8px; border-radius: 12px; }
        
        .toggle-wrapper { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-muted); cursor: pointer; }
        .toggle-input { display: none; }
        .toggle-track { width: 32px; height: 18px; background: #e5e7eb; border-radius: 9px; position: relative; transition: background 0.2s; }
        .toggle-thumb { width: 14px; height: 14px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .toggle-input:checked + .toggle-track { background: var(--primary); }
        .toggle-input:checked + .toggle-track .toggle-thumb { transform: translateX(14px); }
        .sub-marks-input { width: 80px; padding: 2px 6px; font-size: 0.8rem; border: 1px solid var(--border); border-radius: 4px; text-align: right; display: none; }
        .sub-marks-input.visible { display: block; }
        
        .options-editor { margin-top: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 4px; border: 1px solid #e5e7eb; }
        .option-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .option-radio { width: 14px; height: 14px; border: 1px solid #ccc; border-radius: 50%; background: white; }
        .option-input { flex: 1; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem; }

        .asset-container { margin: 0.5rem 0; }
        .asset-item { display: flex; align-items: flex-start; gap: 1rem; background: #f8fafc; border: 1px solid var(--border); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; }
        .asset-preview { width: 80px; height: 80px; background: #e2e8f0; border-radius: 4px; object-fit: cover; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden; }
        .asset-preview img { width: 100%; height: 100%; object-fit: cover; }
        .asset-details { flex: 1; }
        .asset-prompt-input { width: 100%; font-size: 0.8rem; color: #4b5563; font-family: monospace; border: 1px solid #e5e7eb; padding: 4px; border-radius: 4px; margin-bottom: 4px;}
        
        .empty-state { text-align: center; color: var(--text-muted); margin-top: 20%; }
        #file-input, #image-upload-input { display: none; }
    </style>
</head>
<body>

    <!-- MAIN NAV (Workflow Switcher) -->
    <nav class="main-nav">
        <div class="nav-item active" id="nav-import" onclick="switchWorkflow('import')">
            üìÇ
        </div>
        <div class="nav-label">Import</div>
        
        <div class="nav-item" id="nav-library" onclick="switchWorkflow('library')">
            üìö
        </div>
        <div class="nav-label">Library</div>
    </nav>

    <!-- APP CONTENT -->
    <div class="app-content">

        <!-- Header -->
        <header class="header">
            <div class="header-brand">
                <div class="header-title">Assessment Admin</div>
                <div class="header-meta" id="header-meta">
                    <span class="badge-mode badge-import" id="mode-badge">IMPORT MODE</span>
                </div>
            </div>
            
            <!-- Actions: Dynamic based on Workflow -->
            <div class="actions" id="action-bar">
                <input type="file" id="file-input" accept=".jsonl">
                <button class="btn" id="btn-upload" onclick="document.getElementById('file-input').click()">üìÅ Upload JSONL File</button>
                <button class="btn btn-primary" id="btn-action" onclick="downloadJSONL()">Publish All</button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="workspace">
            <aside class="sidebar">
                <!-- Module 1: IMPORT (File Based) -->
                <div id="module-import" class="sidebar-module active">
                    <div class="sidebar-filter">
                        <div style="font-size:0.85rem; color:#666; margin-bottom:0.5rem;">Upload new questions to review and publish.</div>
                    </div>
                    <div class="sidebar-header-status">
                         <span id="import-count">0 Items</span>
                         <span id="import-status">No File</span>
                    </div>
                    <div id="import-list" class="q-list"></div>
                </div>

                <!-- Module 2: LIBRARY (DB Based) -->
                <div id="module-library" class="sidebar-module">
                    <div class="sidebar-search">
                        <div class="search-row">
                            <select class="search-select" id="filter-grade">
                                <option value="grade_3">Grade 3</option>
                                <option value="grade_4">Grade 4</option>
                            </select>
                            <select class="search-select" id="filter-subject">
                                <option value="mathematics">Mathematics</option>
                                <option value="english">English</option>
                            </select>
                        </div>
                        <div class="search-row">
                             <select class="search-select" id="filter-chapter">
                                <option value="all">All Chapters</option>
                                <option value="ch_measurement">Measurement</option>
                                <option value="ch_addition">Addition</option>
                                <option value="ch_subtraction">Subtraction</option>
                                <option value="ch1">Ch 1 (Eng)</option>
                            </select>
                        </div>
                        <button class="fetch-btn" onclick="fetchQuestions()">Fetch Questions</button>
                    </div>
                    <div class="sidebar-header-status">
                        <span id="library-count">0 Items</span>
                        <span id="library-status">Ready</span>
                    </div>
                    <div id="library-list" class="q-list"></div>
                </div>
            </aside>

            <main class="editor" id="main-editor">
                <div id="empty-state" class="empty-state">
                    <p>Select a question to start editing.</p>
                </div>

                <div id="editor-wrapper" style="display:none;">
                    <div class="editor-card">
                        <!-- Metadata Header -->
                        <div class="card-header">
                            <div class="header-top">
                                <div class="meta-group">
                                    <span class="badge-draft" id="meta-id">ID</span>
                                    <select class="btn btn-sm" id="meta-pool-type" onchange="updateMeta('pool_type', this.value)">
                                        <option value="practice">Practice Pool</option>
                                        <option value="exam">Exam Pool</option>
                                    </select>
                                    <select class="btn btn-sm" id="meta-difficulty" onchange="updateMeta('difficulty', this.value)">
                                        <option value="easy">Easy</option>
                                        <option value="medium">Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                    <div style="display:flex; align-items:center; gap:4px;">
                                        <input type="number" class="btn btn-sm" style="width:60px; text-align:right;" id="meta-points" onchange="updateMeta('points', this.value)" title="Points">
                                        <span style="font-size:0.8rem; color:var(--text-muted);">marks</span>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="deleteQuestion()">Delete Question</button>
                            </div>
                            <!-- TABS -->
                            <div class="card-tabs">
                                <div class="tab-btn active" id="tab-edit" onclick="switchTab('edit')">Edit</div>
                                <div class="tab-btn" id="tab-preview" onclick="switchTab('preview')">Preview (A4)</div>
                            </div>
                        </div>

                        <!-- Content Body -->
                        <div class="card-body">
                            
                            <!-- VIEW: EDIT (Container for Graph/JSON) -->
                            <div id="view-edit" class="edit-view-container active">
                                <!-- Toolbar -->
                                <div class="editor-toolbar">
                                    <div class="toolbar-left">
                                        <div class="toolbar-group">
                                            <span class="toolbar-label">Layout</span>
                                            <button class="btn btn-sm" id="btn-layout-stack" onclick="setLayout('stack')">‚ò∞ Stacked</button>
                                            <button class="btn btn-sm" id="btn-layout-grid" onclick="setLayout('grid')">‚äû Grid</button>
                                        </div>
                                        <div class="toolbar-group">
                                            <span class="toolbar-label">Assets</span>
                                            <button class="btn btn-sm" onclick="addAssetToPrompt()">+ Add Image</button>
                                        </div>
                                    </div>
                                    
                                    <div class="toolbar-right">
                                        <!-- SUB VIEW TOGGLE -->
                                        <div class="view-toggle">
                                            <button class="view-toggle-btn active" id="subview-graphical" onclick="switchSubView('graphical')">Graphical</button>
                                            <button class="view-toggle-btn" id="subview-json" onclick="switchSubView('json')">JSON</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- SUB-VIEW: GRAPHICAL (Default) -->
                                <div id="sub-view-graphical" class="graphical-view">
                                    <!-- Main Prompt -->
                                    <div class="content-section">
                                        <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Question Prompt</label>
                                        <textarea class="input-bare prompt-input" id="input-prompt" oninput="updatePrompt(this.value)" placeholder="Enter question text..."></textarea>
                                        <div id="prompt-assets" class="asset-container"></div>
                                    </div>

                                    <!-- Stimulus -->
                                    <div id="stimulus-section" class="content-section" style="display:none; background:#fffbeb; padding:1rem; border-radius:6px; border:1px dashed #fcd34d;">
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                                            <label style="font-size:0.75rem; font-weight:700; color:#b45309;">SHARED CONTEXT (STIMULUS)</label>
                                            <button class="btn btn-sm" onclick="addAssetToStimulus()" style="background:white; border-color:#fcd34d; color:#b45309;">+ Add Image</button>
                                        </div>
                                        <textarea class="input-bare" id="input-stimulus" oninput="updateStimulus(this.value)" placeholder="Enter passage or context..."></textarea>
                                        <div id="stimulus-assets" class="asset-container"></div>
                                    </div>

                                    <!-- Sub-Questions -->
                                    <div class="content-section">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                                            <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Sub-Questions / Answer</label>
                                        </div>
                                        <div
